@{
    Layout = "~/Views/Shared/_LayoutMain.cshtml";  // Exclude the Main layout
}

<body>
    <!-- Navigation-->
    <nav class="navbar navbar-light bg-white static-top">
        <div class="container d-flex justify-content-end">
            <div class="ml-auto">
                <a class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" asp-controller="MESSAGES" asp-action="Create">Contact Admin</a>
                <a class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm" asp-controller="Home" asp-action="Index">Admin Login</a>
            </div>
        </div>
    </nav>
    <!-- Masthead-->
    <header class="newmasthead">
        <div class="container position-relative">
            <div class="row justify-content-center">
                <div class="col-xl-8">
                    <div class="text-center text-dark">
                        <h1 class="mb-5 p-2">"The only thing that you absolutely have to know, is the location of the library"<br />Albert Einstein</h1>
                        
                        <form class="form-subscribe mb-2" id="searchForm">
                            <!-- Search field -->
                            <div class="row">
                                <div class="col">
                                    <input class="form-control form-control-lg" id="searchBook" name="searchBook" type="text" placeholder="Search Books" autocomplete="off" />
                                </div>
                            </div>
                        </form>
                        <!-- Search results will be displayed here -->
                        <table class="table table-striped mt-3" id="searchResultsTable" style="display:none;">
                            <thead>
                                <tr>
                                    <th>Item ID</th>
                                    <th>Title</th>
                                    <th>Author</th>
                                    <th>Product Type</th>
                                    <th>Genre</th>
                                    <th>Availability</th>
                                </tr>
                            </thead>
                            <tbody id="searchResultsBody">
                                <!-- Rows will be dynamically added here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <!-- Icons Grid-->
    <section class="features-icons text-center">
        <div class="container">
            <div class="row">
                <div class="col-auto">
                    <h3>Welcome to Sydenham Library</h3>
                    <p class="lead mb-0">
                        Sydenham Library provides a wide range of educational resources, including books, CDs,
                        and digital materials, across various subjects like computing and business. Our new Online Library Management
                        System allows you to easily search, reserve, and access resources from anywhere. Join us today
                        and enhance your learning experience!
                    </p>
                </div>
@*                 <div class="col-lg-8">
                    <div class="features-icons-item mx-auto mb-5 mb-lg-0 mb-lg-3">
                        <div class="features-icons-icon d-flex"><i class="bi-layers m-auto text-primary"></i></div>
                        <h3>Welcome to Sydenham Library</h3>
                        <p class="lead mb-0">Sydenham Library provides a wide range of educational resources, including books, CDs, 
                            and digital materials, across various subjects like computing and business. Our new Online Library Management 
                            System allows you to easily search, reserve, and access resources from anywhere. Join us today 
                            and enhance your learning experience!</p>
                    </div>
                </div>
                <div class="col-lg-2">

                </div> *@
            </div>
        </div>
    </section>
    <!-- Footer-->
    <footer class="bg-body-tertiary text-center">
        <!-- Grid container -->
        <div class="container p-4 pb-0">
            <!-- Section: Social media -->
            <section class="mb-4">
                <!-- Facebook -->
                <a data-mdb-ripple-init
                   class="btn text-white btn-floating m-1"
                   style="background-color: #3b5998;"
                   href="#!"
                   role="button">
                    <i class="fab fa-facebook-f"></i>
                </a>

                <!-- Twitter -->
                <a data-mdb-ripple-init
                   class="btn text-white btn-floating m-1"
                   style="background-color: #55acee;"
                   href="#!"
                   role="button">
                    <i class="fab fa-twitter"></i>
                </a>

                <!-- Google -->
                <a data-mdb-ripple-init
                   class="btn text-white btn-floating m-1"
                   style="background-color: #dd4b39;"
                   href="#!"
                   role="button">
                    <i class="fab fa-google"></i>
                </a>

                <!-- Instagram -->
                <a data-mdb-ripple-init
                   class="btn text-white btn-floating m-1"
                   style="background-color: #ac2bac;"
                   href="#!"
                   role="button">
                    <i class="fab fa-instagram"></i>
                </a>

                <!-- Linkedin -->
                <a data-mdb-ripple-init
                   class="btn text-white btn-floating m-1"
                   style="background-color: #0082ca;"
                   href="#!"
                   role="button">
                    <i class="fab fa-linkedin-in"></i>
                </a>
                <!-- Github -->
                <a data-mdb-ripple-init
                   class="btn text-white btn-floating m-1"
                   style="background-color: #333333;"
                   href="#!"
                   role="button">
                    <i class="fab fa-github"></i>
                </a>
            </section>
            <!-- Section: Social media -->
        </div>
        <!-- Grid container -->
        <!-- Copyright -->
        <!-- Copyright -->
    </footer>
    <!-- End Footer-->
</body>

<!-- Modal Structure to Reserve a Book -->
<div class="modal fade" id="bookModal" tabindex="-1" aria-labelledby="bookModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalLabel">Book Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Dynamic book details will be loaded here -->
                <p id="modalItemId"></p>
                <p id="modalBookTitle"></p>
                <p id="modalBookAuthor"></p>
                <p id="modalBookProductType"></p>
                <p id="modalBookGenre"></p>
                <span style="color:red">
                    <strong>Please note:</strong> Once you reserve a book, you must collect it from the library within 3 days.
                    If the book is not collected within this time frame, your reservation will be canceled.</span>
            </div>
            <div style="padding-left:3%">
                <div class="col-md-8 form-group mb-3">
                    @* <label asp-for="From" class="control-label"></label> *@
                    <input id="reservationName" class="form-control" placeholder="Your Name" required />
                    <span  class="text-danger"></span>
                </div>
                <div class="col-md-8 form-group mb-3">
                    @* <label asp-for="Phone" class="control-label"></label> *@
                    <span class="text-danger"></span>
                    <input id="reservationPhone" class="form-control" placeholder="Your Phone Number" required />
                    
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" id="saveReserve" class="btn btn-primary">Reserve</button>
            </div>
        </div>
    </div>
</div>


<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        //Book Search
        $('#searchBook').on('keyup', function () {
            let query = $(this).val();

            if (query.length > 0) {
                $.ajax({
                    url: '@Url.Action("SearchBooks", "Home")', // Adjust the action URL if necessary
                    type: 'POST',
                    data: { searchBook: query },
                    success: function (data) {
                        let tableBody = $('#searchResultsBody');
                        let table = $('#searchResultsTable');
                        tableBody.empty(); // Clear previous results

                        if (data.length > 0) {
                            table.show(); // Show the table if results are found

                            data.forEach(function (book) {
                                // Determine the background color based on the availability status
                                let availabilityColor = '';
                                let actionButton = ''; // Initialize actionButton as an empty string

                                if (book.availability === 'Available') {
                                    availabilityColor = 'background-color: green; color: white;';
                                    actionButton = `<button class="btn btn-sm btn-primary open-modal" data-itemid="${book.itemId}" data-title="${book.title}" data-author="${book.author}" data-producttype="${book.productType}" data-genre="${book.genre}">Reserve</button>`;
                                } else if (book.availability === 'Reserved') {
                                    availabilityColor = 'background-color: red; color: white;';
                                }

                                tableBody.append(`
                                <tr>
                                    <td>${book.itemId}</td>
                                    <td>${book.title}</td>
                                    <td>${book.author}</td>
                                    <td>${book.productType}</td>
                                    <td>${book.genre}</td>
                                    <td style="${availabilityColor}">${book.availability}</td>
                                    <td>${actionButton}</td>
                                </tr>
                                `);
                            });
                        } else {
                            // table.hide(); // Hide the table if no results
                            tableBody.append('<tr><td colspan="5">No books found.</td></tr>');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error("Error: " + error); // Log client-side errors
                    }
                });
            } else {
                $('#searchResultsTable').hide(); // Hide the table if the input is empty
            }
        });

        function formatAvailabilityCell(availability) {
            let style = '';

            if (availability === 'Available') {
                style = 'background-color: green; color: white;';
            } else if (availability === 'Reserved') {
                style = 'background-color: red; color: white;';
            }

            return `<td style="${style}">${availability}</td>`;
        }

        //JavaScript to Handle Modal Opening
        $(document).on('click', '.open-modal', function () {
            // Get book details from the clicked button's data attributes
            let ItemId = $(this).data('itemid');
            let title = $(this).data('title');
            let author = $(this).data('author');
            let productType = $(this).data('producttype');
            let genre = $(this).data('genre');

            // Set the book details in the modal
            $('#modalItemId').text('Item ID: ' + ItemId);
            $('#modalBookTitle').text('Title: ' + title);
            $('#modalBookAuthor').text('Author: ' + author);
            $('#modalBookProductType').text('Product Type: ' + productType);
            $('#modalBookGenre').text('Genre: ' + genre);

            // Show the modal
            $('#bookModal').modal('show');
        });
        
        //Create Reservation Record
        $(document).on('click', '#saveReserve', function () {
            let itemIdText = $('#modalItemId').text();
            let itemId = parseInt(itemIdText.replace(/\D/g, '')); // Remove non-digit characters and convert to integer
            let reservedBy = $('#reservationName').val();
            let reservedByPhone = $('#reservationPhone').val();
            console.log(itemId);
            if (reservedBy && reservedByPhone) {
                $.ajax({
                    url: '@Url.Action("CreateReservation", "Reservations")', // Adjust action and controller
                    type: 'POST',
                    data: {
                        Prodid: itemId,
                        Reservedby: reservedBy,
                        Reservedbyphone: reservedByPhone
                    },
                    success: function (response) {
                        // Handle success (e.g., close modal, show a success message)
                        $('#bookModal').modal('hide');
                        alert('Reservation successful! The book is now reserved.');
                        window.location.reload();
                    },
                    error: function (xhr, status, error) {
                        console.error("Error: " + error); // Log any errors
                        alert('An error occurred while processing your reservation.');
                    }
                });
            } else {
                alert('Please fill your name and mobile number.');
            }
        });
    });
</script>